{
    "id": 21236040590994,
    "url": "https://discoverxi-supportdesk.zendesk.com/api/v2/help_center/en-us/articles/21236040590994.json",
    "html_url": "https://discoverxi-supportdesk.zendesk.com/hc/en-us/articles/21236040590994-Troubleshooting-Mail-Delivery-Issues-A-Comprehensive-Guide",
    "author_id": 1904316023094,
    "comments_disabled": false,
    "draft": false,
    "promoted": false,
    "position": 0,
    "vote_sum": 0,
    "vote_count": 0,
    "section_id": 20635898698130,
    "created_at": "2024-09-08T11:49:47Z",
    "updated_at": "2024-11-06T16:19:00Z",
    "name": "Troubleshooting Mail Delivery Issues: A Comprehensive Guide",
    "title": "Troubleshooting Mail Delivery Issues: A Comprehensive Guide",
    "source_locale": "en-us",
    "locale": "en-us",
    "outdated": false,
    "outdated_locales": [],
    "edited_at": "2024-11-06T16:19:00Z",
    "user_segment_id": 360000084973,
    "permission_group_id": 1075294,
    "content_tag_ids": [],
    "label_names": [
        "Troubleshooting",
        "EFS GUI",
        "Hurricane Server",
        "Cron Jobs",
        "Mail Delivery",
        "Service Gateway",
        "Grafana"
    ],
    "body": "<h1 id=\"h_01J78QJP1MSXHBV222J1E2SSHG\">Overview</h1>\n<p>This guide helps you investigate and resolve mail delivery issues within DXI through different systems. New agents can follow this overview to understand the high-level troubleshooting process and then click the links for detailed instructions.</p>\n<ol>\n<li>\n<p><strong>EFS GUI Investigation</strong><br>Start by checking the mail status and customer configurations in the <strong>EFS GUI</strong>. You will <a href=\"#h_01J7949RSZDW1XGPK9E063SG52\">locate the mailing ID</a>, check the <a href=\"#h_01J794AA4SCCKAA7ADY0MMKB64\">mail queue</a>, review <a href=\"#h_01J794AX0EJW61KWMT8MGN18ZJ\">mail configurations</a> and confirm most of the information about individual mails for each recipient within a given mailing ID.<br>ðŸ‘‰ <a href=\"#h_01J78RA1VF65QSS35YQASAT5RG\">Go to EFS GUI Investigation</a></p>\n</li>\n<li>\n<p><strong>Service Gateway Access (MariaDB Query)</strong><br>Use the <strong>Service Gateway</strong> to access MariaDB for more in-depth investigation. You can run SQL queries to track individual mail status, failure codes, and other critical details (including the actual mail dispatch date for each recipient, since not on GUI).<br>ðŸ‘‰ <a href=\"#h_01J78YBGZFJ2X1RN6ZZR82WBHC\">Go to Service Gateway Access</a></p>\n</li>\n<li>\n<p><strong>Hurricane Server Logs and GUI</strong><br>Further troubleshoot by accessing <strong>Hurricane Server Logs</strong> and using the <strong>Hurricane GUI</strong> to check the mail relay server and account configurations. Enable outbound logging to capture more information if necessary.<br>ðŸ‘‰ <a href=\"#h_01J7943JG3GGY7J7YDC726VRS9\">Go to Hurricane Server Logs and GUI</a></p>\n</li>\n<li>\n<p><strong>Checking Cron Jobs in Grafana</strong><br>If emails are stuck or delayed, check <strong>Grafana logs</strong> to verify the status of the cron jobs responsible for mail dispatch (snailmail) and mail status ingestion (jobmaker).<br>ðŸ‘‰ <a href=\"#h_01J79604RA91E8BMHTQ4XWZ7WB\">Go to Cron Jobs in Grafana</a></p>\n</li>\n<li>\n<p><strong>RabbitMQ Access for Mail Troubleshooting</strong><br>For rare cases where deeper analysis is required, access <strong>RabbitMQ</strong> to check the status of emails and confirm they have been processed. This step is generally not needed unless other avenues have been exhausted.<br>ðŸ‘‰ <a href=\"#h_01J7968EFFEK122YN48DQ2ZKGE\">Go to RabbitMQ Access</a></p>\n</li>\n<li>Special Customizations: <a href=\"#h_01J9K53NMVD5NP08D5AQKRVPE9\">Intervista</a>, <a href=\"#h_01J9KW4QRRKKW9KMDTY49F90PA\">Bofa</a>\n</li>\n</ol>\n<h1 id=\"h_01J78QJP1M1FQA69FJP33QP041\">Solution</h1>\n<h2 id=\"h_01J78RA1VF65QSS35YQASAT5RG\"><strong>1. EFS GUI Investigation</strong></h2>\n<p><strong>Goal:</strong> Start by using the EFS GUI to check mail status and customer configurations related to the issue.</p>\n<ol>\n<li>\n<h4 id=\"h_01J7949RSZDW1XGPK9E063SG52\">\n<strong>Locate mailing ID: </strong>If the customer doesn't share this, you can locate it using 2 paths:</h4>\n<ul>\n<li>If you know the project, Open<code>Project -&gt; Mail report -&gt; select the mailID</code> matching the customer complain (might be by date)</li>\n<li>Otherwise: <code>System -&gt; Options -&gt; Mail Queue</code>, and search for the mailing using the date of any other available information.</li>\n<li>If you still cannot locate the mailing ID, please get back to customer to share more information about the missing mail.</li>\n</ul>\n</li>\n<li>\n<h4 id=\"h_01J794AA4SCCKAA7ADY0MMKB64\"><strong>Check the mails status:<br></strong></h4>\nOnce you get the mailing ID, note the following information:\n<ul>\n<li>On the mailings list <strong>dashboard</strong>, you can locate some information about the mailing:<br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21238953666962\"><br>\n<ul>\n<li>For example, this screenshot indicates the following:\n<ul>\n<li>\n<strong>Total</strong>: 2028 mails should be sent under this mailing ID</li>\n<li>\n<strong>Date</strong>: The planned date and time to start sending this mailing queue.</li>\n<li>\n<strong>Queued</strong>: 1960 are in queue pending a cron job to send them once the date starts</li>\n<li>\n<strong>Sending</strong>: 68 are already dispatched or relayed. But they do not appear as sent yet, sinceÂ  there is a workflow to confirm mail delivery from recipient server, this is not completed yet.</li>\n<li>Note that mails are sent in batches every 10 mins, as explained later, that why if a date is already in past, the queue is consumed in batches, which should decrease every 10 minutes.</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>You can then open the Mailing List details:\n<ul>\n<li><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21238937635474\"></li>\n<li>\n<strong>1: Date</strong>: this is the same date as shown on dashboard, The planned date and time to start sending this mailing queue.</li>\n<li>\n<strong>2: Filter</strong> to show which individual mails to check under this mailing ID, change that to <strong>ALL</strong> if not sure</li>\n<li>\n<strong>3: View</strong> button: To select which fields to view for individual mails. Make sure \"<strong>Date</strong>\" field is selected</li>\n<li>\n<strong>4: Individual mail status: </strong>This includes:\n<ul>\n<li><strong>Recipient</strong></li>\n<li>Individual mail <strong>Status</strong>\n</li>\n<li>\n<strong>Date</strong>: Date of individual mail status ingestion.Â  (in <em>mail_rcpt</em> table)\n<ul>\n<li>To explain: the individual email is queued, then delivered (through EFS account or customer mail server), then a callback confirmation is sent to our RabbitMQ, then there is a cronjob (pickupmailNotifications) which reads (ingests) the MQ, and updates EFS with the updated status.</li>\n<li>Accordingly, This datetime is always after the MailingID date, and the customer might actually receive the email before that datetime (till the confirmation is sent back to us and ingested).</li>\n<li>So depending on customer configurations (as explained later), and amount of mails to send, the mails are queued in batches, thus this date field will be different across individual mails within the same mailing ID.</li>\n<li>The most accurate sent time is available in<strong> DB and Hurricane logs only.</strong>Â <br><br>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<h4 id=\"h_01J794AX0EJW61KWMT8MGN18ZJ\"><strong>Installation Configuration - Mail server configurations:</strong></h4>\n<ul>\n<li style=\"list-style-type: none;\">\n<ul>\n<li>As a <strong>root</strong> user, you can check mailing server configurations (i.e.: mail server address, port, username, protocol, logs, etc...) through: <code>System &gt; Options &gt; Platform cockpit &gt; [root only] System ConfigurationsÂ </code>, then search for <strong>Hurricane</strong>\n</li>\n<li><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21238953668626\"></li>\n<li>If the <strong>hurricane_xxx_serverÂ </strong>value points to a <strong>postfix</strong> server value (ex: '<strong>postfix</strong>-<strong>production</strong>.global-services.svc.cluster.local'), this indicates mails are sent through EFS Hurricane standard MTA (not using customer mail server). In this case, note the first string after the postfix string, usually refers to the Account name used in Hurricane (to be used later). In the above example, the account name is \"Production\".</li>\n<li>If the <strong>hurricane_xxx_serverÂ </strong>value points toÂ an IP (10.250.xx.xx), this indicates the mails are sent through a custom email server. Note the IP and user values as they will be used on Hurricane side to locate the sending account details.</li>\n<li>If the <strong>hurricane_xxx_serverÂ </strong>value points to <code>email-smtp.us-east-1.amazonaws.com</code>, then this is AWS hosted, not using Hurricane. Check details in <a href=\"#h_01J9KW4QRRKKW9KMDTY49F90PA\">Special Customization - Bofa</a> section</li>\n<li>Note that <strong>hurricane_snailmail_server </strong>is used to send bulk emails, while <strong>hurricane_adhoc_serverÂ </strong>is used to send adhoc emails, like individual password reset. Both should ideally point to similar values (either postfix or external IP), but they are different here for testing/illustration purposes.</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<h4 id=\"h_01J794B2T6XBV6RYJ1D238NSMD\"><strong>Installation Configuration - Mail Queue Behavior:</strong></h4>\n<ul>\n<li>\n<p>[No root needed] Check customer-specific settings related to mailing under <strong>System &gt; Options &gt; System Settings<img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21238953669778\"></strong></p>\n</li>\n<li>These configurations are <strong>applicable only for customer mail servers</strong> (since the remote server might not be reliable). <strong>They do not affect postmail configurations</strong>\n<ul>\n<li>Postmail retry configurations can be checked in Hurricane.</li>\n<li>Choose <strong>Account EFS-Production</strong>, then <strong>Deferral settings</strong>:<strong><br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21240419517074\"><br></strong>\n</li>\n</ul>\n</li>\n<li>\n<p><strong>Mail volume per mail Interval: </strong>The mails in the queue are processed in packages: per default, up to 300 mails will be processed in 10 minute intervals. The default value of 300 mails per interval can be changed: up to 2000 mails can be sent per interval.</p>\n</li>\n</ul>\n</li>\n<li>\n<h4 id=\"01J7DEEW9F5B1146W3HEKBSCM2\"><strong>Installation Configuration - Cronjob status</strong></h4>\n<ul>\n<li>If you believe mails are stuck in the queue, you can check if the cronjobs are working fine for the installation through EFS GUI, <strong>System &gt; Options &gt; Platform Cockpit &gt;Â  Installation Check</strong>:<br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21272009043346\">\n</li>\n</ul>\n</li>\n</ol>\n<h2 id=\"h_01J78YBGZFJ2X1RN6ZZR82WBHC\"><strong>2. Service Gateway Access (MariaDB Query)</strong></h2>\n<p><strong>Goal:</strong> Use Service Gateway to access detailed data for more in-depth analysis.</p>\n<ul>\n<li>\n<a href=\"https://discoverxi-supportdesk.zendesk.com/hc/en-us/articles/21140364670866-How-to-Access-and-Work-with-MariaDB-on-DXI-Service-Gateways\">Access the MariaDB instance</a> via Service Gateway to gather further insights using the provided mail ID.</li>\n<li>Note about dates:\n<ul>\n<li>Dates in DB are always in UTC.</li>\n<li>Dates in server logs are usually German time (+2 or +1 according to Daylight savings)</li>\n</ul>\n</li>\n<li>Use the following SQL query to fetch individual mail details from the database\n<ul>\n<li>\n<pre>SELECT h.mail_id, sd.pid, mr.sid, h.uid, h.mailing_id, <br>  mr.rcpt_hash, h.message_id, <br>  mp.dt AS date_time_efs_mail_job_creation_utc, <br>  h.date_time AS date_time_hurricane_mail_dispatch_in_utc, <br>  FROM_UNIXTIME(mr.dt) AS date_time_mail_status_ingestion_utc, <br>  LEFT(IFNULL(h.response, mr.status_reason), 3) AS response, <br>  IFNULL(h.failure_code, \"\") AS failure_code <br>FROM mail_hurricane_notification_queue AS h <br>LEFT JOIN mail_rcpt AS mr ON (h.rcpt_hash = mr.rcpt_hash AND h.mail_id = mr.mail_id) <br>LEFT JOIN sample_data AS sd ON (mr.sid = sd.sid) <br>LEFT JOIN mail_prot AS mp ON (h.mail_id = mp.mail_id) <br>WHERE h.mail_id = [Mail_ID] GROUP BY mr.uid;</pre>\n</li>\n<li>Replace the [Mail_ID] with the target mailingID.</li>\n</ul>\n</li>\n<li>Check the results, here are the details of the fields:\n<ul>\n<li>\n<strong>UID: </strong>User Id of the recipient</li>\n<li>\n<strong>PID: </strong>Survey/project ID</li>\n<li>\n<strong>SID:Â </strong>Sample ID, which is usually projectID + 1 (indicating \"Internal\" sample), or might refer to other project samples.</li>\n<li>\n<strong>rcpt_hash: </strong>Hash for this recipient, can be used to search the logs</li>\n<li>\n<strong>message_id: </strong>Concatenation of rcpt_hash, mail_id, uid, PID, SID; to be used to search logs</li>\n<li>\n<strong>date_time_efs_mail_job_creation_utc </strong>(mail_prot table): Date of creating the mailing ID to initiate the communication. This date is on GUI.</li>\n<li>\n<strong>date_time_hurricane_mail_dispatch_in_utc: </strong>Date of sending the message to customer. <span class=\"wysiwyg-color-red\"><strong>This date is not on UI</strong>, but it is an important date to confirm when was the mail dispatched from EFS side.</span>\n</li>\n<li>\n<strong>date_time_mail_status_ingestion_utc: </strong>Data the confirmation of delivery was ingested into EFS. This date is on GUI</li>\n<li>\n<strong>response: </strong>Response code on UI</li>\n<li>\n<strong>failure_code: </strong>This is an additional 4 digit code, not on UI I believe , but can provide more (accurate) information about the error. You can lookup these codes on the internet, or check the following code file (in the installation folder - <span class=\"wysiwyg-font-size-small\"><code>/nfs/installations/kd7885/nfs/opst/&lt;installation&gt;.customervoice360.com/htdocs</code></span>):\n<pre> vi modules/efs/components/mail/engine/hurricane/notification/codes.inc.php</pre>\n<img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21238953670674\">\n</li>\n</ul>\n</li>\n</ul>\n<p>Â </p>\n<h2 id=\"h_01J7943JG3GGY7J7YDC726VRS9\"><strong>3. Hurricane Server Logs and GUI</strong></h2>\n<p><strong>Goal:</strong> Further investigation using Hurricane server logs and the Hurricane GUI.</p>\n<ul>\n<li>\n<h4 id=\"h_01J9K63AGHP5JHTGC7AQ140XXN\"><strong>Access Hurricane GUI as per the article: <a href=\"https://discoverxi-supportdesk.zendesk.com/hc/en-us/articles/21139518716562-How-to-Access-and-Work-with-DXI-Service-Gateways#01J8QS4CEBNQQ6KPMT655G7Y13\">How to Access Hurricane Server</a></strong></h4>\n<ul>\n<li>\n<p>Log into the Hurricane GUI and check for the account being used to send the emails.</p>\n</li>\n<li>\n<p>According to <a href=\"#h_01J794AX0EJW61KWMT8MGN18ZJ\">EFS GUI configurations</a>, if customer is using postmail configurations, the account name is embedded in the server name in EFS GUI (as explained earlier), but if using an IP, you will need to look for the account name:</p>\n<ul>\n<li>\n<p>Option 1: Click \"Accounts\" in Hurricane, then you look for the account based on the name of the customer (and having a similar active account name). You can confirm that the username in EFS UI is matching the username in Hurricane UI:<br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21238953672210\"></p>\n</li>\n<li><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21238953672722\" width=\"494\" height=\"300\"></li>\n<li>Option 2: Click \"IP Addresses\" in Hurricane GUI, and look for accounts matching the IP address in EFS GUI<br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21238953673362\">\n</li>\n<li>Option 3: check the customer name in <a href=\"https://qbdocs.atlassian.net/wiki/spaces/PROC/pages/3505422353/Hurricane+Socketlabs+MTA+Overview\">this table</a> mapping Public IPs vs Private IPs vs Customer names (these are static values, might be changed very rarely)</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<h4 id=\"h_01J9K631HCXWGBRW6SV27DFCKM\"><strong>Enable Outbound Logs:</strong></h4>\n<ul>\n<li>To enable more logs in Hurricane server for outbound mails, go to:\n<ul>\n<li>Hurricane GUI &gt; Choose account &gt; Logging &gt; Enable outbound logsÂ <br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21977598898450\" width=\"270\" height=\"214\"><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21977622004754\" width=\"281\" height=\"218\">\n</li>\n</ul>\n</li>\n<li>Note that this would increase the amount of logs, so please make sure to revert it after testing.</li>\n</ul>\n</li>\n<li>\n<h4 id=\"h_01J9K62X9TY3ZT1WFSVH47K99P\"><strong>Review Hurricane Server Logs:</strong></h4>\n<ul>\n<li>Access the Hurricane server logs through the GUI: <code>LogViewer -&gt; Choose Account -&gt; Download</code> (make sure to select the account related to your customer)<br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21624761114130\">\n</li>\n<li>\n<p><span class=\"wysiwyg-color-black40\">[Obsolete - Ignore] It is possible to Access the Hurricane server logs through the /hurricanelogs/&lt;AccountID&gt;/logfiles directory on Hurricane server backend, but this is not needed/useful since we have GUI access.</span></p>\n<ul>\n<li>\n<span class=\"wysiwyg-color-black40\">Here are the account IDs for some common account names (to save time checking HurricaneUI to get <strong>account ID</strong>):</span>\n<ul>\n<li><span class=\"wysiwyg-color-black40\">EFS-Production: 1006</span></li>\n<li><span class=\"wysiwyg-color-black40\">EFS-Adhoc: 1007</span></li>\n<li><span class=\"wysiwyg-color-black40\">EFS-Pending-Confirmation: 1047</span></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>For more detailed logging information, look for the following:\n<ul>\n<li>\n<strong>Queue logs</strong>: This shows when the mail was queued in Hurricane.</li>\n<li>\n<strong>Process logs</strong>: Indicates when the email was successfully dispatched or if there were issues.</li>\n<li>Review <strong>deferred emails</strong>: These logs indicate when emails were temporarily delayed and retried by the system.</li>\n</ul>\n</li>\n<li>Logs are partitioned by Day.</li>\n<li>You can use the messageID or rcptID for a quick match.</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"h_01J79604RA91E8BMHTQ4XWZ7WB\"><strong>4. Checking Cron Jobs in Grafana</strong></h2>\n<p><strong>Goal:</strong> Use Grafana logs to verify the status of the cron jobs involved in mail dispatch and notification ingestion.</p>\n<p><strong>When to use?</strong></p>\n<ul>\n<li>This can be useful if the emails are stuck in queue without being delivered, or if an email was delivered after a large delay than the expected delivery time.</li>\n<li>Usually, Hurricane UI shows no errors for this account, also Hurricane logs show no error, since mails are stuck waiting for the cronjob to pick them up.</li>\n</ul>\n<h4 id=\"h_01J7961PT83HF18MWW5A6KZW9R\"><strong>Grafana Overview:</strong></h4>\n<p>Grafana provides insights into the performance and status of various processes, including the cron jobs responsible for mailing. Two key cron jobs are essential in the email sending and status feedback loops: <strong>snailmail</strong> and <strong>jobmaker </strong>(which starts <strong>pickupmailNotifications </strong>job).</p>\n<h3 id=\"h_01J7961PT8BBPQWN9TXMGFHJRK\"><strong>4.1 Accessing Grafana (WIP: Access in progress)</strong></h3>\n<ol>\n<li>Log in to <strong>Grafana</strong> using the provided Azure AD credentials:<strong><br><a style=\"margin: 0px; padding: 0px; font-size: 14px; vertical-align: baseline; background: #fff7ed; cursor: pointer; text-decoration: none; color: #1f73b7; box-sizing: border-box; line-height: inherit; font-family: system-ui, -apple-system, BlinkMacSystemFont, ' Segoe UI' , Roboto, Oxygen-Sans, Ubuntu, Cantarell, ' Helvetica Neue' , Arial, sans-serif; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal;\" href=\"https://grafana.prod-de-03.customervoice360.com/login\" rel=\"noopener noreferrer\">https://grafana.prod-de-03.customervoice360.com/login</a><span style=\"color: #2f3941; font-family: system-ui, -apple-system, BlinkMacSystemFont, ' Segoe UI' , Roboto, Oxygen-Sans, Ubuntu, Cantarell, ' Helvetica Neue' , Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: #fff7ed; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">Â </span><br style=\"box-sizing: border-box; line-height: inherit; color: #2f3941; font-family: system-ui, -apple-system, BlinkMacSystemFont, ' Segoe UI' , Roboto, Oxygen-Sans, Ubuntu, Cantarell, ' Helvetica Neue' , Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: #fff7ed; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;\"><a style=\"margin: 0px; padding: 0px; font-size: 14px; vertical-align: baseline; background: #fff7ed; cursor: pointer; text-decoration: none; color: #1f73b7; box-sizing: border-box; line-height: inherit; font-family: system-ui, -apple-system, BlinkMacSystemFont, ' Segoe UI' , Roboto, Oxygen-Sans, Ubuntu, Cantarell, ' Helvetica Neue' , Arial, sans-serif; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal;\" href=\"https://grafana.prod-us-03.customervoice360.com/login\" rel=\"noopener noreferrer\">https://grafana.prod-us-03.customervoice360.com/login</a><span style=\"color: #2f3941; font-family: system-ui, -apple-system, BlinkMacSystemFont, ' Segoe UI' , Roboto, Oxygen-Sans, Ubuntu, Cantarell, ' Helvetica Neue' , Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: #fff7ed; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">Â </span><br style=\"box-sizing: border-box; line-height: inherit; color: #2f3941; font-family: system-ui, -apple-system, BlinkMacSystemFont, ' Segoe UI' , Roboto, Oxygen-Sans, Ubuntu, Cantarell, ' Helvetica Neue' , Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: #fff7ed; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;\"><a style=\"margin: 0px; padding: 0px; font-size: 14px; vertical-align: baseline; background: #fff7ed; cursor: pointer; text-decoration: none; color: #1f73b7; box-sizing: border-box; line-height: inherit; font-family: system-ui, -apple-system, BlinkMacSystemFont, ' Segoe UI' , Roboto, Oxygen-Sans, Ubuntu, Cantarell, ' Helvetica Neue' , Arial, sans-serif; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal;\" href=\"https://grafana.sandbox-de-02.customervoice360.com/login\" rel=\"noopener noreferrer\">https://grafana.sandbox-de-02.customervoice360.com/login</a><span style=\"color: #2f3941; font-family: system-ui, -apple-system, BlinkMacSystemFont, ' Segoe UI' , Roboto, Oxygen-Sans, Ubuntu, Cantarell, ' Helvetica Neue' , Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: #fff7ed; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">Â </span><br style=\"box-sizing: border-box; line-height: inherit; color: #2f3941; font-family: system-ui, -apple-system, BlinkMacSystemFont, ' Segoe UI' , Roboto, Oxygen-Sans, Ubuntu, Cantarell, ' Helvetica Neue' , Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: #fff7ed; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;\"><a style=\"margin: 0px; padding: 0px; font-size: 14px; vertical-align: baseline; background: #fff7ed; cursor: pointer; text-decoration: none; color: #1f73b7; box-sizing: border-box; line-height: inherit; font-family: system-ui, -apple-system, BlinkMacSystemFont, ' Segoe UI' , Roboto, Oxygen-Sans, Ubuntu, Cantarell, ' Helvetica Neue' , Arial, sans-serif; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal;\" href=\"https://grafana.bofa-us-01.customervoice360.com/login\" rel=\"noopener noreferrer\">https://grafana.bofa-us-01.customervoice360.com/login</a></strong>\n</li>\n<li>Navigate to the <strong>Dashboard</strong> (Dashboards &gt; Legacy &gt; EFS Single Installation) where the cron job metrics are visualized, then choose <strong>installation</strong>:<br><img src=\"https://central-supportdesk.zendesk.com/attachments/token/xcCErSrfSLjZP12ERDABxAXED/?name=image.png\">\n</li>\n<li>Adjust filter on top header:<br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21240387809170\">\n</li>\n<li>Expand \"CronJobs\", you need to focus on 2 jobs <code>snailmail</code> and <code>jobmaker</code> cron jobs.</li>\n<li>The expected behavior is that the age of jobs is 10 mins, then it is closed and a new one starts:<br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21240371921042\">\n</li>\n</ol>\n<p>Â </p>\n<h3 id=\"h_01J7961PT8E19DXQD8FHCNAH4Z\"><strong>4.2 Understanding the Two Key Cron Jobs</strong></h3>\n<h4 id=\"h_01J7961PT8BW50N74Q3FE6NYVE\"><strong>a. Snailmail Cron Job:</strong></h4>\n<p>This job is responsible for dispatching mails from the <strong>EFS mail queue</strong> to the <strong>Hurricane MTA</strong> (Mail Transfer Agent). It runs every <strong>10 minutes</strong>, with a slight random offset to avoid all installations running simultaneously.</p>\n<ul>\n<li>\n<strong>Functionality:</strong>\n<ul>\n<li>Checks if there are mails waiting in the <strong>mails table</strong>.</li>\n<li>Sends out a <strong>batch</strong> of emails (by default, 300 emails every 10 minutes).</li>\n<li>Processes these emails and forwards them to the <strong>Postfix</strong> queue which eventually pushes them to <strong>Hurricane </strong>(or pushes custom server).</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"h_01J79DAVYTPV6QVA0Q8K6TD7VB\">\n<strong>b. Jobmaker Cron Job, </strong>which starts <strong>pickupmailNotifications </strong>job<strong>:</strong>\n</h4>\n<p>PickupmailNotifications is responsible for ingesting the <strong>email status notifications</strong> that Hurricane (or customer mail server) sends back to EFS. It checks for messages in <strong>RabbitMQ</strong> and updates the status of mails in EFS accordingly.</p>\n<ul>\n<li>\n<p><strong>Functionality:</strong></p>\n<ul>\n<li>Runs every <strong>10 minutes</strong> and queries the <strong>RabbitMQ</strong> for any updates on the status of the sent mails.</li>\n<li>Takes the <strong>status messages</strong> from Hurricane (e.g., delivered, failed, deferred) and updates the relevant tables in EFS (e.g., <code>mail_hurricane_notification_queue</code>).</li>\n<li>If the jobmaker is <strong>stuck</strong> or delayed, there can be a discrepancy between the actual time an email was delivered and when it is logged in EFS.</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"01J79DK8WD1VATMCS4ZY57SC50\"><strong>4.3 Checking Cron Jobs Status in Grafana</strong></h3>\n<ul>\n<li>Check the time intervals between executions to ensure they follow the expected schedule. Below is a sample wrong schedule (where age is 1.3 days,)<br><img src=\"https://central-supportdesk.zendesk.com/attachments/token/gV4GAfzAVILUs8iywXrAyn2jJ/?name=image.png\"><br>\n<ul>\n<li>In this example, mails were stuck for 1.36 days, they were not delivered (since snalmail was stuck), and EFS was not updated (since JobMaker was stuck).</li>\n</ul>\n</li>\n<li>You can also check the logs of the cron jobs in Grafana:\n<ul>\n<li>Choose <strong>Explore </strong>option and <strong>Loki </strong>value, then put the needed filters as shown below<br style=\"box-sizing: border-box; line-height: inherit; color: #2f3941; font-family: system-ui, -apple-system, BlinkMacSystemFont, ' Segoe UI' , Roboto, Oxygen-Sans, Ubuntu, Cantarell, ' Helvetica Neue' , Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: #fff7ed; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;\"><span style=\"margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: baseline; background: #fff7ed; box-sizing: border-box; line-height: inherit; color: #2f3941; font-family: system-ui, -apple-system, BlinkMacSystemFont, ' Segoe UI' , Roboto, Oxygen-Sans, Ubuntu, Cantarell, ' Helvetica Neue' , Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; opacity: 1;\"><img style=\"vertical-align: baseline; border: 0px; margin: 0px; padding: 0px; outline: 0px; background: transparent; box-sizing: border-box; line-height: inherit; object-fit: scale-down; aspect-ratio: auto; inline-size: auto; max-block-size: 75dvb; block-size: auto; max-width: 100%; max-inline-size: 100%;\" src=\"https://central-supportdesk.zendesk.com/attachments/token/MbhuIZVUbnZJ1fy6jbfrRxmLy/?name=image.png\"></span>\n</li>\n</ul>\n</li>\n</ul>\n<p>Â </p>\n<h2 id=\"h_01J7968EFFEK122YN48DQ2ZKGE\">5. RabbitMQ Access for Mail Troubleshooting</h2>\n<p><a href=\"https://discoverxi-supportdesk.zendesk.com/hc/en-us/articles/21237628865682-Understanding-RabbitMQ-and-How-is-RabbitMQHash-calculated\"> Check this article</a> if you need to check the status of message in RabbitMQ</p>\n<p>Â </p>\n<h2 id=\"h_01J9K53NMVD5NP08D5AQKRVPE9\">6. Special Customizations:</h2>\n<ol>\n<li>\n<h4 id=\"h_01J9KW3G0XCT5XMAGPXNYRPF84\"><strong>Intervista</strong></h4>\n<ul>\n<li>\n<strong>Intervista </strong>is the only customer which has a customization to update the sent status of an email. Email is sent similar to other customers, only the status update after delivery is customized.</li>\n<li>For all customers, there is a callback mechanism from the custom mailserver through RabbitMQ to instruct EFS that the message was delivered. However for Intervista, this part is customized.Â </li>\n<li>For <strong>Intervista</strong>, if an email is <strong>stuck</strong> in \"<strong>Sending</strong>\" status, perform the following:\n<ul>\n<li>Confirm if the email was relayed by Hurricane to custom mail server, by checking <a href=\"#h_01J9K62X9TY3ZT1WFSVH47K99P\">Hurricane logs</a>\n<ul>\n<li>If email is not delivered for any reason, then this is still our scope, we need to investigate the reasons.</li>\n<li>If email is delivered, but GUI is not updated back, then this should be PS scope.\n<ul>\n<li>Ideally, If you look at the DB you only can see the information updated in the <code>mail_rcpt</code> table but not in the <code>mail_hurricane_notification_queue</code> table. This is expected behavior for this customer, which should update the GUI</li>\n<li><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21824354491922\"></li>\n<li>If the <code>mail_rcpt</code>Â is not populated, then this is PS Scope.<br>\n<div>The customizing can be found here btw:<br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21824354494866\">\n</div>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<h4 id=\"h_01J9KW4QRRKKW9KMDTY49F90PA\"><strong>BofA-US-01</strong></h4>\n<ul>\n<li>The <strong>BofA-US-01</strong> cluster does not use Hurricane MTA at all. It is special and uses AWS mailing service as one of their explicit requirements. The whole process setting up a new sender address in the AWS (including DKIM and SPF) never had been passed to L2. This is usually SaaS scope.<br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21835384530578\">\n</li>\n<li>You can check the email logs in AWS account 169014870358, Role: <span style=\"color: #000000; font-family: Helvetica, Arial, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: bold; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">RAM-AWS-tivian-inc-bofa-us-ReadOnly:<code>SES &gt; Virtual Deliverability Manager &gt; Dashboard &gt; Messages </code></span><span style=\"color: #000000; font-family: Helvetica, Arial, sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; float: none; display: inline !important;\"><code>tab &gt; <strong>Search</strong></code> <em>(Access in progress)</em></span>\n</li>\n</ul>\n</li>\n</ol>\n<p>Â </p>\n<h1 id=\"h_01J78QJP1M5VCDFJJHHGNANQ4Z\">Summary</h1>\n<p>This guide provides a comprehensive solution to troubleshoot mail delivery issues. It covers various aspects, including EFS GUI investigation, Service Gateway access, Hurricane server logs and GUI, and checking cron jobs in Grafana for mail issues.</p>\n<h2 id=\"h_01J78QJP1MXXYB3457GHD7YYH6\">FAQ</h2>\n<p><strong>1. What is the EFS GUI and how can it help in troubleshooting mail delivery issues?</strong><br>The EFS GUI provides mail statistics and customer configurations, allowing you to identify the status of mail delivery and spot potential configuration issues.</p>\n<p><strong>2. How can Service Gateway access help in resolving mail delivery issues?</strong><br>Service Gateway access enables running database queries and checking installation details, helping to trace mail flow and diagnose delivery errors.</p>\n<p><strong>3. What are the common issues that can cause mail delivery problems and how can they be addressed?</strong><br>Common issues include email queuing delays, blacklisting, or VPN instability, which can be addressed by adjusting cron job intervals, reviewing server logs, or fixing network connections.</p>",
    "user_segment_ids": [
        360000084973
    ]
}