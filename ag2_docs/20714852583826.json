{
    "id": 20714852583826,
    "url": "https://discoverxi-supportdesk.zendesk.com/api/v2/help_center/en-us/articles/20714852583826.json",
    "html_url": "https://discoverxi-supportdesk.zendesk.com/hc/en-us/articles/20714852583826-Fix-survey-tables-with-duplicate-variables",
    "author_id": 369584192734,
    "comments_disabled": false,
    "draft": true,
    "promoted": false,
    "position": 0,
    "vote_sum": 0,
    "vote_count": 0,
    "section_id": 20714530860562,
    "created_at": "2024-08-12T17:03:13Z",
    "updated_at": "2024-08-12T17:03:15Z",
    "name": "Fix survey tables with duplicate variables",
    "title": "Fix survey tables with duplicate variables",
    "source_locale": "en-us",
    "locale": "en-us",
    "outdated": false,
    "outdated_locales": [],
    "edited_at": "2024-08-12T17:03:15Z",
    "user_segment_id": 360000084973,
    "permission_group_id": 1075294,
    "content_tag_ids": [],
    "label_names": [],
    "body": "<p><b>Original Confluence URL:</b> <a href=\"https://qbdocs.atlassian.net/wiki/spaces/TS/pages/2335408154\">https://qbdocs.atlassian.net/wiki/spaces/TS/pages/2335408154</a> - please cross-check the quality of the ZD article with the Confluence counterpart and remove this line before publishing the ZD article</p>\n\n<p>es gibt ein von Bernd erstelltes Script zum Fixen solcher Geschichten:</p><p><a href=\"http://mercurial.3uu.de/hgweb.cgi/sandboxBernd/file/fc398feb8097/survey/fixSurveyContent.php\">http://mercurial.3uu.de/hgweb.cgi/sandboxBernd/file/fc398feb8097/survey/fixSurveyContent.php</a></p><p>oder zBsp in Frankfurt hier zu finden: /dumps/_DONT_DELETE_thurn</p><p>Bevor das Skript aufgerufen werden kann, müssen im Skript die Variablen zum Einloggen in die Datenbank ($__dbhost, $__dbuser, etc.) analog zu den Werten in der conf/config.inc.php der betroffenen Installation angepasst werden.</p><p>Voraussetzung für ein Gelingen ist auch, dass es während des Vorgangs keine Teilnahmen gibt und dass auch niemand an der Survey über den Adminbereich herumfummelt. Das muss am besten mit dem Kunden abgesprochen werden.</p><p>Das Skript wird dann zuerst mit dem -t switch aufgerufen. -t Steht für Test. Der Aufruf ist aber notwendig, weil das Skript hier nicht nur prüft, ob es doppelte Variablen gibt, sondern auch ALTER TABLE statements ausgibt, die später auf die neu erstellten Tabellen angewandt werden müssen.</p><p>Als Parameter übergibt man die pid des betroffenen Projekts.</p><p>Am besten pipet man sich die Ausgabe also in eine Datei, zBsp:</p><p>php fixSurveyContent.php -t 79803 &gt; /dumps/fix_79803.sql</p><p>oder</p><p>php fixSurveyContent.php -t 79803 | tee /dumps/fix_79803.sql, damit man die Ausgabe auch sehen kann. Vielleicht kann man auch noch ein grep ALTER so einfügen, dass nur die Ausgabe in die Datei gefiltert wird.</p><p>Aus der Datei entfernt man dann alle weiteren Zeilen, außer den ALTER TABLE statements, so dass man die Datei dann späters sourcen kann.</p><p>Der zweite Aufruf geschieht dann mit -f anstatt -t:</p><p>php fixSurveyContent.php -f 79803</p><p>Ausgabe sollte so aussehen:</p><p>Creating table copy fixed_content_survey_79803_1<br>Creating table copy fixed_content_survey_79803_2<br>Done, find new tables/view prefixed with 'fixed_content_'</p><p>In der Datenbank zeigt ein SHOW TABLES like “%79803%” jetzt unter anderem die fixed_content_survey Tabellen. Es kann auch einen fixed_survey_ View geben, der also hinten keine _x Nummer hat.</p><p>Um ein Backup zu erstellen, jetzt die Original Basistabellen und den VIEW renamen.</p><p>Die folgenden Aktionen erfolgen alle auf dem MASTER. Einloggen also per efslogin -mo. In der AWS gibt es nur noch den Master.</p><p>rename table survey_79803_1 to original_survey_79803_1;<br>rename table survey_79803_2 to original_survey_79803_2;<br>rename table survey_79803_3 to original_survey_79803_3;<br>rename table survey_79803_4 to original_survey_79803_4;<br>rename table survey_79803 to original_survey_79803;</p><p>Jetzt die Original Basistabellen durch die vom Skript erstellten Tabellen ersetzen. Das selbe beim VIEW.</p><p>rename table fixed_content_survey_79803_1 to survey_79803_1;<br>rename table fixed_content_survey_79803_2 to survey_79803_2;<br>rename table fixed_content_survey_79803_3 to survey_79803_3;<br>rename table fixed_content_survey_79803_4 to survey_79803_4;<br>rename table fixed_content_survey_79803 to survey_79803;</p><p>Der gefixte View verweist er auf die originalen Basistabellen, also auf die Namen ohne fixed_content_ Prefix. </p><p>Dann müssen die ALTER TABLE Statements, die das Skript im -t Durchlauf erstellt hat, ausgeführt werden. Das geht auf die gefixten Tabellen, die zu diesem Zeitpunkt aber schon umbenannt worden sind.</p><p>source /dumps/fix_79803.sql</p><p>Bevor man generiert, muss der memcache geflushed werden.</p><p>Dazu kann man per helpersEfsGetConfiguration memcache_servers, die IP des konfigurierten memcache Servers herausfinden.</p><p>Danach per 'telnet memcache-IP' 11211 mit dem memcache Server verbinden.</p><p>flush_all<br>quit</p><p>Dann über die EFS GUI die Survey ‘ohne Datenlöschen’ zurücksetzen, um hoffentlich ohne Fehler zu generieren.</p>",
    "user_segment_ids": [
        360000084973
    ]
}