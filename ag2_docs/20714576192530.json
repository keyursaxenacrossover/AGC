{
    "id": 20714576192530,
    "url": "https://discoverxi-supportdesk.zendesk.com/api/v2/help_center/en-us/articles/20714576192530.json",
    "html_url": "https://discoverxi-supportdesk.zendesk.com/hc/en-us/articles/20714576192530-Elastic-Search",
    "author_id": 369584192734,
    "comments_disabled": false,
    "draft": true,
    "promoted": false,
    "position": 0,
    "vote_sum": 0,
    "vote_count": 0,
    "section_id": 20714530860562,
    "created_at": "2024-08-12T16:49:52Z",
    "updated_at": "2024-08-12T16:49:54Z",
    "name": "Elastic Search",
    "title": "Elastic Search",
    "source_locale": "en-us",
    "locale": "en-us",
    "outdated": false,
    "outdated_locales": [],
    "edited_at": "2024-08-12T16:49:54Z",
    "user_segment_id": 360000084973,
    "permission_group_id": 1075294,
    "content_tag_ids": [],
    "label_names": [],
    "body": "<p><b>Original Confluence URL:</b> <a href=\"https://qbdocs.atlassian.net/wiki/spaces/TS/pages/1055031476\">https://qbdocs.atlassian.net/wiki/spaces/TS/pages/1055031476</a> - please cross-check the quality of the ZD article with the Confluence counterpart and remove this line before publishing the ZD article</p>\n\n<h2>Table of Contents</h2>\n<ul class=\"toc\">\n<ul>\n<li><a href=\"#header-1\">General information</a></li>\n<ul>\n<li><a href=\"#header-3\">Activation</a></li>\n<ul>\n<li><a href=\"#header-5\">Config Flags:</a></li>\n<li><a href=\"#header-6\">Panel modules:</a></li>\n</ul>\n<li><a href=\"#header-8\">Support</a></li>\n<ul>\n<li><a href=\"#header-10\">How to check wether an index exists in elastic search:</a></li>\n<li><a href=\"#header-11\">How to create an index or how to reset it:</a></li>\n<li><a href=\"#header-12\">How to check wether a data set exists in elastic search:</a></li>\n<li><a href=\"#header-13\">How to delete an index from elastic search:</a></li>\n<li><a href=\"#header-14\">How to get the amount read requests per Elastic Search index (installation)</a></li>\n</ul>\n</ul>\n<li><a href=\"#header-17\">Elastic Search in Cloud</a></li>\n<ul>\n<li><a href=\"#header-19\">Good-to-know curls</a></li>\n<ul>\n<li><a href=\"#header-21\">Check Cluster Health</a></li>\n<li><a href=\"#header-22\">Ensure Enough Disk Space</a></li>\n<li><a href=\"#header-23\">Check Node Availability</a></li>\n<li><a href=\"#header-24\">Summary of all shards for an index</a></li>\n</ul>\n<li><a href=\"#header-26\">Handling Translog Corruption in Elasticsearch</a></li>\n</ul>\n</ul>\n</ul><h1 id=\"header-1\">General information</h1><h2 id=\"header-3\">Activation</h2><p> Elastic Search is available since EFS 10.6 but inactive by default. First since EFS 10.7 it is active by default.</p><h3 id=\"header-5\">Config Flags:</h3><p> Bremen:</p><ul>\n<li><p><strong>elasticsearch_configuration (Standard:JA)</strong> <em><strong>__________________________</strong></em>: array ( 'connections' =&gt; array ( 0 =&gt; array ( 'host' =&gt; 'elasticsearch', 'port' =&gt; 9200, ), ), )</p></li>\n<li><p><strong>elasticsearch_enabled (Standard:JA)</strong> <em><strong>__________________________</strong></em>: true</p></li>\n</ul><p>Testkanal:</p><ul>\n<li><p><strong>elasticsearch_configuration (Standard:NEIN)</strong> <em><strong>__________________________</strong></em>: array ( 'connections' =&gt; array ( 0 =&gt; array ( 'host' =&gt; 'tka055', 'port' =&gt; 9200, ), ), )</p></li>\n<li><p><strong>elasticsearch_enabled (Standard:JA)</strong> <em><strong>__________________________</strong></em>: true</p></li>\n</ul><p>Procus3:</p><ul>\n<li><p><strong>elasticsearch_configuration (Standard:NEIN)</strong> <em><strong>__________________________</strong></em>: array ( 'connections' =&gt; array ( 0 =&gt; array ( 'host' =&gt; '<a href=\"http://elasticsearch.bre.globalpark.com\">elasticsearch.bre.globalpark.com</a>', 'port' =&gt; 9200, ), ), )</p></li>\n<li><p><strong>elasticsearch_enabled (Standard:JA)</strong> <em><strong>__________________________</strong></em>: true</p></li>\n</ul><p>Rackspace:</p><ul>\n<li><p><strong>elasticsearch_configuration (Standard:NEIN)</strong> <em><strong>__________________________</strong></em>: array ( 'connections' =&gt; array ( 0 =&gt; array ( 'host' =&gt; 'elasticsearch', 'port' =&gt; 9200, ), ), 'retryOnConflict' =&gt; 5, )</p></li>\n<li><p><strong>elasticsearch_enabled (Standard:JA)</strong> <em><strong>__________________________</strong></em>: true</p></li>\n</ul><h3 id=\"header-6\">Panel modules:</h3><p> New content handler \"activity stream\" and \"panel search\" are based on elastic search. Activities are stored in type \"panel_activities\".</p><h2 id=\"header-8\">Support</h2><h3 id=\"header-10\">How to check wether an index exists in elastic search:</h3><ul><li>\n<p>Via the console:</p>\n<ul><li><pre><code class=\"language-text\">curl -XGET 'http://elasticsearch.{{TECHNICALNAME}}.svc.cluster.local:9200/_cat/indices?v'</code></pre></li></ul>\n</li></ul><h3 id=\"header-11\">How to create an index or how to reset it:</h3><ul><li>\n<p>Via the console:</p>\n<ul>\n<li><p>Navigate to the installations htdocs/www folder</p></li>\n<li>\n<p>Panel:</p>\n<pre><code class=\"language-text\">php support/panel_reset_activitystream.php</code></pre>\n</li>\n<li>\n<p>Portals</p>\n<pre><code class=\"language-text\">php support/portal_reset_activitystream.php</code></pre>\n</li>\n</ul>\n</li></ul><h3 id=\"header-12\">How to check wether a data set exists in elastic search:</h3><ul>\n<li>\n<p>There is a plug-in for Google Chrome browser called „Sense“</p>\n<ul><li><p><a href=\"https://chrome.google.com/webstore/detail/sense-beta/lhjgkmllcaadmopgmanpapmpjgmfcfig\">https://chrome.google.com/webstore/detail/sense-beta/lhjgkmllcaadmopgmanpapmpjgmfcfig</a></p></li></ul>\n</li>\n<li>\n<p>alternatively one can check via the console (e.g. putty):</p>\n<ul>\n<li><p>search for data set with activity_id, adjust database name and activity_id <br>curl -XGET '<a href=\"#\">http://elasticsearch.bre.globalpark.com:9200/[dbname]/panel_activities/_search?q=activity_id:[activity_id]</a>'</p></li>\n<li>\n<p>other possible search attributes:</p>\n<ul>\n<li>\n<p>user_id</p>\n<ul><li><pre><code class=\"language-text\">curl -XGET 'http://elasticsearch.{{TECHNICALNAME}}.svc.cluster.local:9200/[dbname]/panel_activities/_search?q=user_id:[user_id]'</code></pre></li></ul>\n</li>\n<li>\n<p>activity_type</p>\n<ul>\n<li><pre><code class=\"language-text\">curl -XGET 'http://elasticsearch.{{TECHNICALNAME}}.svc.cluster.local:9200/[dbname]/panel_activities/_search?q=activity_type:[type]'</code></pre></li>\n<li>\n<p>possible types:</p>\n<ul>\n<li><p>110 forum_thread_created</p></li>\n<li><p>120 forum_post_created</p></li>\n<li><p>210 blog_instance_created</p></li>\n<li><p>220 blog_post_created</p></li>\n<li><p>230 blog_post_comment_created</p></li>\n<li><p>310 discussion_post_created</p></li>\n<li><p>410 file_upload</p></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>activity_id</p></li>\n<li><p>activity_title</p></li>\n<li><p>activity_description</p></li>\n<li><p>activity_files</p></li>\n<li><p>activity_section</p></li>\n<li><p>activity_section_type_id</p></li>\n<li><p>context_external_filename</p></li>\n<li><p>context_internal_filename</p></li>\n<li><p>context_filesize</p></li>\n<li><p>context_lang_id</p></li>\n<li><p>context_download_section_id</p></li>\n<li><p>context_download_section_title</p></li>\n<li><p>meta_created_at</p></li>\n<li><p>meta_updated_at</p></li>\n<li><p>meta_access_groups</p></li>\n<li><p>meta_published</p></li>\n<li><p>meta_created_at_time</p></li>\n<li><p>meta_updated_at_time</p></li>\n<li><p>meta_is_updated</p></li>\n<li><p>sync_at</p></li>\n<li><p>meta_read_user_ids</p></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>In the database check table <strong>panel_activities_sync_log</strong></p>\n<ul><li><pre><code class=\"language-text\">select * from panel_activities_sync_log where object_id=[id]</code></pre></li></ul>\n</li>\n</ul><h3 id=\"header-13\">How to delete an index from elastic search:</h3><ul><li><pre><code class=\"language-text\">curl -XDELETE 'http://elasticsearch.{{TECHNICALNAME}}.svc.cluster.local:9200/[dbname]'</code></pre></li></ul><h3 id=\"header-14\">How to get the amount read requests per Elastic Search index (installation)</h3><p> Get Read Stats per Index</p><ul>\n<li><p>cd /opt/pdp/support/localScripts</p></li>\n<li><p>/opt/pdp/opst/apps/php-5.3.6/bin/php /opt/pdp/support/localScripts/getElasticSearchReads.php</p></li>\n<li>\n<p>output looks like this:</p>\n<pre><code class=\"language-text\">Index: opst_xyz             had: 123456789   read requests</code></pre>\n</li>\n</ul><h1 id=\"header-17\">Elastic Search in Cloud</h1><p>check Elastic Search config in database settings, the value is called “conenctions” and should look something like : elasticsearch.ab1234.svc.cluster.local </p><p>(efslogin -&gt;select * from config_variables where name like “%elastic%”\\G)</p><p>Then the curl is similar to the old one:</p><pre><code class=\"language-text\">curl -XGET 'http://elasticsearch.{{TECHNICALNAME}}.svc.cluster.local:9200/_cat/indices?v' </code></pre><p></p><h2 id=\"header-19\"><strong>Good-to-know curls</strong></h2><h3 id=\"header-21\">Check Cluster Health</h3><p>Checking the detailed health of your cluster, especially around the affected index. This can provide insights into which shards are unallocated or causing the issue:</p><pre><code class=\"language-text\">curl -XGET 'http://elasticsearch.{{TECHNICALNAME}}.svc.cluster.local:9200/_cluster/health/opst_xh0589?pretty'</code></pre><h3 id=\"header-22\">Ensure Enough Disk Space</h3><p>Check if there is enough disk space on the nodes. Elasticsearch will not allocate shards to a node that has crossed a certain disk watermark (by default, 85% full). You can check the disk usage with:</p><pre><code class=\"language-text\">curl -XGET 'http://elasticsearch.{{TECHNICALNAME}}.svc.cluster.local:9200/_cat/nodes?v&amp;h=ip,disk.avail'</code></pre><h3 id=\"header-23\">Check Node Availability</h3><p>Make sure that all nodes expected to be part of the cluster are up and running. A missing node which holds replicas could be the cause:</p><pre><code class=\"language-text\">curl -XGET 'http://elasticsearch.{{TECHNICALNAME}}.svc.cluster.local:9200/_cat/nodes?v'</code></pre><h3 id=\"header-24\">Summary of all shards for an index</h3><p>This command is used to retrieve a readable summary of all the shards for an index, including details like shard number, primary or replica status, state, and more. It's useful for quick diagnostics and monitoring of the shard distribution and health within an Elasticsearch cluster.</p><pre><code class=\"language-text\">curl -XGET 'http://elasticsearch.{{TECHNICALNAME}}.svc.cluster.local:9200/_cat/shards/opst_{{TECHNICALNAME}}?v'</code></pre><p></p><h2 id=\"header-26\">Handling Translog Corruption in Elasticsearch</h2><p><strong>Overview</strong><br>The transaction log (translog) in Elasticsearch plays a critical role in ensuring data durability between flushes to disk, by recording all operations that modify data. Corruption of the translog can prevent shards from recovering and cause data loss, often resulting from hardware failures, abrupt system shutdowns, or file system issues.</p><p><strong>Symptoms</strong><br>Typical symptoms of translog corruption include:</p><ul>\n<li><p>Errors during shard recovery, often marked by <code>IndexShardGatewayRecoveryException</code> and <code>TranslogCorruptedException</code> in the Elasticsearch logs.</p></li>\n<li><p>Failure to restart a node or to recover an index after a restart.</p></li>\n</ul><p><strong>Preventive Measures</strong><br>To minimize the risk of translog corruption:</p><ul>\n<li><p>Ensure all Elasticsearch nodes are shut down gracefully.</p></li>\n<li><p>Use reliable hardware and conduct regular health checks on your storage systems.</p></li>\n<li><p>Configure frequent snapshots to safeguard data and facilitate easier recovery.</p></li>\n</ul><p><strong>Diagnosis</strong><br>When suspecting translog corruption, examine the Elasticsearch logs for stack traces or error messages indicating <code>TranslogCorruptedException</code>. These logs provide insights into which shard and node are affected.</p><p><strong>Recovery Steps</strong></p><ol start=\"1\">\n<li>\n<p><strong>Identify and Isolate the Issue:</strong></p>\n<ul>\n<li><p>Confirm the corruption by checking logs for translog-related errors.</p></li>\n<li><p>Identify the affected node and shard.</p></li>\n</ul>\n</li>\n<li>\n<p><strong>Remove Corrupted Translog Files:</strong></p>\n<ul>\n<li><p>Navigate to the translog directory (<code>/var/lib/elasticsearch/nodes/0/indices/[index_name]/[shard_id]/translog</code>).</p></li>\n<li><p>Make a backup of the existing translog files.</p></li>\n<li><p>Remove the corrupted translog files to allow Elasticsearch to attempt to rebuild them from the last successful checkpoint.</p></li>\n</ul>\n</li>\n<li>\n<p><strong>Restart the Node:</strong></p>\n<ul><li><p>Restart the Elasticsearch node to trigger recovery. If the translog was the only issue, the shard should recover successfully.</p></li></ul>\n</li>\n<li>\n<p><strong>Restore from Backup:</strong></p>\n<ul><li><p>If shard recovery fails or significant data loss is observed, restore the affected index or shard from a recent snapshot.</p></li></ul>\n</li>\n<li>\n<p><strong>Monitor and Validate:</strong></p>\n<ul>\n<li><p>After recovery, monitor the logs and cluster health to ensure no further issues occur.</p></li>\n<li><p>Validate the integrity of the data by running consistency checks or comparing document counts.</p></li>\n</ul>\n</li>\n<li><p><strong>Run the panel_reset_activitystream.php script</strong> - the documentcount should recover over time by itself.</p></li>\n</ol><p></p><p></p>",
    "user_segment_ids": [
        360000084973
    ]
}