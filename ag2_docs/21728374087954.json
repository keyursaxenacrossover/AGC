{
    "id": 21728374087954,
    "url": "https://discoverxi-supportdesk.zendesk.com/api/v2/help_center/en-us/articles/21728374087954.json",
    "html_url": "https://discoverxi-supportdesk.zendesk.com/hc/en-us/articles/21728374087954-Troubleshooting-Panelist-Registration-Key-Issues-in-Recruitment-Campaigns",
    "author_id": 1904316023094,
    "comments_disabled": false,
    "draft": false,
    "promoted": false,
    "position": 0,
    "vote_sum": 0,
    "vote_count": 0,
    "section_id": 20234751255186,
    "created_at": "2024-10-02T07:18:09Z",
    "updated_at": "2024-10-02T15:51:04Z",
    "name": "Troubleshooting Panelist Registration Key Issues in Recruitment Campaigns",
    "title": "Troubleshooting Panelist Registration Key Issues in Recruitment Campaigns",
    "source_locale": "en-us",
    "locale": "en-us",
    "outdated": false,
    "outdated_locales": [],
    "edited_at": "2024-10-02T15:51:02Z",
    "user_segment_id": 360000084973,
    "permission_group_id": 1075294,
    "content_tag_ids": [],
    "label_names": [
        "Recruitment Campaigns",
        "Database Logs",
        "SQL Query",
        "Grafana Loki",
        "Panelist Registration",
        "Registration Key Issue",
        "Web Server Access Logs",
        "Fraud Prevention"
    ],
    "body": "<h1 id=\"h_01J962W3YA94GXX1WJ60YKXE30\">Overview</h1>\n<p>This guide provides steps for troubleshooting an issue where panelists have been registered under specific recruitment campaigns (e.g., PB_JUN_24, PB_JUL_24), but no associated registration keys are found in the system. This situation often raises concerns regarding the integrity of the registration process and potential fraud risks.</p>\n<p><strong>Issue Description</strong></p>\n<p>Customers may encounter cases where panelists have completed registration through recruitment suppliers using unique registration keys (<span style=\"color: #2f3941; font-family: system-ui, -apple-system, BlinkMacSystemFont, ' Segoe UI' , Roboto, Oxygen-Sans, Ubuntu, Cantarell, ' Helvetica Neue' , Arial, sans-serif; font-size: 14px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: #ebf9f9; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;\">created by going to People-&gt;panel configuration-&gt;ways of entry-&gt;generate keys)</span>.<br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21739279818130\"><br>Note in this example, the number of keys used for this \"Way of Entry\" is 111 keys.</p>\n<p>However, in some instances, more panelists might be found related to this Way of Entry (accessed through People -&gt; Panelist administration -&gt; Advanced Search), in this example there are 119 panelists using the 111 keys:<br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21739295530386\"><br>This indicates that there are some panelists in the system with no corresponding \"used keys\" associated with their registrations. This is problematic as registration codes are meant to be one-time-use, preventing multiple panelists from registering with the same key.</p>\n<p>Customer might provide a sample Panelist code or Pseudonym not showing in the extracted used keys.</p>\n<p>Customer might request to confirm <strong>which codes were used by which Panelists?</strong></p>\n<h1 id=\"h_01J96YTAVPRW2QAAX0Z2AHW5F9\">Possible Root Cause</h1>\n<p>The issue likely arises due to the same <strong>LMI key</strong> (unique registration code) being sent to multiple panelists who used it within a short time frame. The root cause seems to be related to how the system handles registration codes at the start and end of the registration process.</p>\n<ul>\n<li>When several panelists started the registration process using the same LMI key, the system did not lock or flag the key as \"used\" at the beginning of the process.</li>\n<li>The key was marked as \"used\" only when the first panelist finalized their registration. As a result, subsequent panelists could still begin their registration using the same key.</li>\n<li>This discrepancy led to a situation where the panelists successfully registered under the same \"Way of entry\" but did not appear in the downloadable list of \"used keys.\" Essentially, only the first panelist to complete the process is recorded as having used the key.</li>\n<li><em>Note that the above is a <strong>theoretical analysis</strong>, if reproduced, please update this article. No Eng ticket was created yet since customer for this ticket was caring about getting the list of codes, not fixing the root cause.</em></li>\n</ul>\n<h1 id=\"h_01J962W3YAZPKVW4JBY9YRWZ12\">Solution</h1>\n<h3 id=\"h_01J964YG3ETAWT6NV6SBYFBBSP\">Steps to Troubleshoot the Issue</h3>\n<h4 id=\"h_01J964YG3E46DZZ0A1DTD4FPPZ\">Step 1: Review the Database for Panelist Registration Records</h4>\n<p>To analyze the panelist records and identify discrepancies, execute the following SQL query to retrieve relevant data from the panelist registration tables.</p>\n<p>Just replace the  <code class=\"!whitespace-pre hljs language-sql\">pa.reg_code</code> in the query below with the correct values for the Way of Entry having the issue.</p>\n<pre><code class=\"language-plaintext\">SELECT\n\tpa.uid,\n\tpa.pseudonym,\n\tp.u_email,\n\tp.u_firstname,\n\tp.u_name,\n\tpa.penter_date,\n\tpa.reg_code,\n\tpe.title,\n\tpav.remote_addr AS ip_on_registration,\n\tprk.rkey\t,\n\tprk.active,\n\tprk.used\nFROM\n\tpanel_att AS pa\n\tLEFT JOIN panel_recruitment_keys AS prk ON ( prk.rid = pa.reg_code AND prk.uid = pa.uid\n\t)\n\tLEFT JOIN panel_entry AS pe ON (pa.reg_code = pe.reg_code)\n\tLEFT JOIN panelists AS p ON (pa.uid = p.uid)\n\tLEFT JOIN panel_att_var AS pav ON (pa.uid = pav.uid)\nWHERE\n\tpa.reg_code IN (136, 139)\n\tAND prk.rid IS NULL\nORDER BY pa.penter_date ASC;</code></pre>\n<ul>\n<li>This query helps to identify the panelists registered under the given campaigns (PB_JUN_24, PB_JUL_24) without corresponding registration keys.<br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21739279832722\">\n</li>\n<li>\n<code>panel_entry</code>: Stores information about the \"ways of entry\" (reg_code and title).</li>\n<li>\n<code>panel_recruitment_keys</code>: Contains information on the actual recruitment keys (<code>rkey</code>) and their statuses (<code>active</code>, <code>used</code>).</li>\n<li>The unique PRI key <code>reg_code</code> from the table <code>panel_entry</code> and the MUL key <code>rid</code> in the table <code>panel_recruitment_keys</code> can be used to join both tables (each way of entry can have N unique LMI keys therefore you have this PRI to MUL relation between those tables)</li>\n<li>\n<strong>Registration IP Address</strong>: Query identifies the IP address the panelist had while registring (Column <code>remote_addr</code> from table <code>panel_att_var</code> which can be joined by the <code>uid</code>)</li>\n</ul>\n<h4 id=\"h_01J964YG3EQC5BPJVHYZPYYRWY\">Step 2: Analyze Web Server Logs with Grafana Loki</h4>\n<p>It is possible to use AWS Cloudwatch logs to get the actual codes used for each panelist, however CW logs are maintained for 1 month only. If the registration is older than 1 month, we would need to check Grafana logs.</p>\n<p>Use <a href=\"https://discoverxi-supportdesk.zendesk.com/hc/en-us/articles/21741183591314-Accessing-and-Querying-Grafana-Logs-A-Comprehensive-Guide\"><strong>Grafana Loki</strong> </a>to investigate web server logs by looking for requests from the IP addresses found in Step 1:</p>\n<ol>\n<li>Open <strong>Grafana Loki</strong> and restrict to the namespace of the installation (e.g., <code>tr9043</code>).</li>\n<li>Run the query for the relevant job (<code>tr9043/nginx</code>) and search for access logs around the registration dates (from <code>pa.penter_date</code>).</li>\n</ol>\n<p>Example of <a href=\"https://grafana.prod-de-03.customervoice360.com/explore?schemaVersion=1&amp;panes=%7B%22sks%22:%7B%22datasource%22:%22P8E80F9AEF21F6940%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22expr%22:%22%7Bnamespace%3D%5C%22tr9043%5C%22,%20job%3D%5C%22tr9043%2Fnginx%5C%22%7D%20%21~%20%60PHP%20Warning%60%20%7C~%20%6082%5C%5C.68%5C%5C.16%5C%5C.244%7C91%5C%5C.149%5C%5C.202%5C%5C.234%7C81%5C%5C.135%5C%5C.6%5C%5C.171%7C2%5C%5C.217%5C%5C.33%5C%5C.83%7C81%5C%5C.129%5C%5C.170%5C%5C.194%7C81%5C%5C.157%5C%5C.66%5C%5C.79%7C92%5C%5C.9%5C%5C.234%5C%5C.52%7C81%5C%5C.174%5C%5C.144%5C%5C.193%60%20%7C~%20%60%60%22,%22queryType%22:%22range%22,%22datasource%22:%7B%22type%22:%22loki%22,%22uid%22:%22P8E80F9AEF21F6940%22%7D,%22editorMode%22:%22builder%22%7D%5D,%22range%22:%7B%22from%22:%221718668800000%22,%22to%22:%221718841599000%22%7D%7D%7D&amp;orgId=1\">a Grafana Loki query</a>:</p>\n<div class=\"dark bg-gray-950 contain-inline-size rounded-md border-[0.5px] border-token-border-medium relative\">\n<div class=\"overflow-y-auto p-4\" dir=\"ltr\">\n<code class=\"!whitespace-pre hljs language-loki\">{namespace=\"tr9043\", job=\"tr9043/nginx\"} |~ \"82.68.16.244\"\n</code><br><img src=\"https://discoverxi-supportdesk.zendesk.com/hc/article_attachments/21739279838610\">\n</div>\n</div>\n<ul>\n<li>This search allows identifying if the registration keys (LMI keys) were accessed, either in the initial request or through the referrer, using the IP addresses.</li>\n<li>To process Grafana logs and extract the codes from logs for a large list, you have the following options:\n<ul>\n<li>Simply download the files and process via editor using RegEx search and Replace to process further via Excel</li>\n<li>If you want to find out about manipulating the displayed logs directly through Grafana, please take a look here: <a href=\"https://grafana.com/blog/2021/08/09/new-in-loki-2.3-logql-pattern-parser-makes-it-easier-to-extract-data-from-unstructured-logs/\">new-in-loki-2.3-logql-pattern-parser</a>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"h_01J964YG3EMPF5BBZPQYM6GV9N\">Step 3: Identify Duplicate Key Usage</h4>\n<p>If multiple panelists have used the same LMI key, it indicates a duplication issue.</p>\n<p>Use the following SQL query to find such duplications:</p>\n<ul>\n<li>Prepare a list of keys used by the problematic IPs (from step 2 above)</li>\n<li>Look for these keys in our DB</li>\n</ul>\n<div class=\"dark bg-gray-950 contain-inline-size rounded-md border-[0.5px] border-token-border-medium relative\">\n<pre class=\"overflow-y-auto p-4\" dir=\"ltr\"><code class=\"!whitespace-pre hljs language-sql\"><span class=\"hljs-keyword\">SELECT</span> \n    pa.uid, \n    pa.pseudonym, \n    pa.penter_date, \n    prk.rkey \n<span class=\"hljs-keyword\">FROM</span> \n    panel_recruitment_keys <span class=\"hljs-keyword\">AS</span> prk \n    <span class=\"hljs-keyword\">LEFT</span> <span class=\"hljs-keyword\">JOIN</span> panel_att <span class=\"hljs-keyword\">AS</span> pa <span class=\"hljs-keyword\">ON</span> (prk.uid <span class=\"hljs-operator\">=</span> pa.uid) \n<span class=\"hljs-keyword\">WHERE</span> \n    prk.rkey <span class=\"hljs-keyword\">IN</span> ( \"...\", \"...\");  <span class=\"hljs-comment\">-- Add relevant keys here</span>\n</code></pre>\n</div>\n<ul>\n<li>This query will return all instances where the same LMI key was used by other panelists, which should not occur as keys are designed for single use.</li>\n<li>So the result of this query, is the original panelist who used this code, while the panelist of steps 1 and 2 are the duplicated ones. </li>\n</ul>\n<h4 id=\"h_01J964YG3EW9B2F5STZJGTPQX2\">Step 4: Resolve Duplicate Key Issue</h4>\n<p>Once duplicate key usage is identified:</p>\n<ul>\n<li>Recommend the customer to ensure that registration keys are only sent to one individual per campaign.</li>\n<li>If requested, share with the customer a report showing the LMI Key and the relevant Panelists who used it, and the time of usage (penter_date).</li>\n<li>Confirm that once a key is used, it becomes deactivated and cannot be reused by others (this might require and Eng Defect if issue is reproducible on our testing Environment).</li>\n<li>You can refer to ticket 4462678 for sample report and more details.</li>\n</ul>\n<h1 id=\"h_01J962W3YA2B0WFGDB1XBRQFM3\">Summary</h1>\n<p>By following these steps, you can identify and analyze issues with panelist registration keys in recruitment campaigns. This will help maintain the integrity of the panelist registration process and support effective fraud prevention.</p>\n<h2 id=\"h_01J962W3YA1YYC97A8V8BDQ541\">FAQ</h2>\n<ol>\n<li>\n<strong>What is the role of Grafana Loki in this process?</strong><br>Grafana Loki is used to identify the registration keys from the initial request by the panelists' IPs. These keys can be found in the request itself or the referrer.</li>\n<li>\n<strong>Why is it important to ensure that each registration key is unique and not duplicated?</strong><br>Unique registration keys are crucial for maintaining the integrity of the panelist registration process and for effective fraud prevention. If keys are duplicated, it can lead to confusion and potential misuse.</li>\n<li>\n<strong>What should I do if I find that the same registration key has been used by multiple panelists?</strong><br>If requested by the customer, share the information of the original and other panelists using the same code.<br>If customer requires a permanent fix for future occurrences, reproduce the issue on our testing env, then raise a Defect as per the standard process.</li>\n</ol>",
    "user_segment_ids": [
        360000084973
    ]
}