{
    "id": 20714744003986,
    "url": "https://discoverxi-supportdesk.zendesk.com/api/v2/help_center/en-us/articles/20714744003986.json",
    "html_url": "https://discoverxi-supportdesk.zendesk.com/hc/en-us/articles/20714744003986-Custom-Routing-Custom-Request-handling",
    "author_id": 369584192734,
    "comments_disabled": false,
    "draft": true,
    "promoted": false,
    "position": 0,
    "vote_sum": 0,
    "vote_count": 0,
    "section_id": 20714530860562,
    "created_at": "2024-08-12T17:00:51Z",
    "updated_at": "2024-08-12T17:00:53Z",
    "name": "Custom Routing (Custom-Request handling)",
    "title": "Custom Routing (Custom-Request handling)",
    "source_locale": "en-us",
    "locale": "en-us",
    "outdated": false,
    "outdated_locales": [],
    "edited_at": "2024-08-12T17:00:53Z",
    "user_segment_id": 360000084973,
    "permission_group_id": 1075294,
    "content_tag_ids": [],
    "label_names": [],
    "body": "<p><b>Original Confluence URL:</b> <a href=\"https://qbdocs.atlassian.net/wiki/spaces/TS/pages/1716617231\">https://qbdocs.atlassian.net/wiki/spaces/TS/pages/1716617231</a> - please cross-check the quality of the ZD article with the Confluence counterpart and remove this line before publishing the ZD article</p>\n\n<h2>Table of Contents</h2>\n<ul class=\"toc\">\n<ul>\n<li><a href=\"#header-1\">TODOs</a></li>\n<ul>\n<li><a href=\"#header-3\">Description</a></li>\n<ul>\n<li><a href=\"#header-5\">Preconditions</a></li>\n<li><a href=\"#header-6\">Implementation</a></li>\n<li><a href=\"#header-7\">Notes</a></li>\n<li><a href=\"#header-8\">Example</a></li>\n<li><a href=\"#header-9\">Firewall based on Custom Routing Plugin</a></li>\n<li><a href=\"#header-10\">set add}itional headers like HSTS:</a></li>\n<li><a href=\"#header-11\">Projects</a></li>\n</ul>\n</ul>\n</ul>\n</ul><p></p><h1 id=\"header-1\">TODOs</h1><ul>\n<li><p>Translation</p></li>\n<li><p>compate the status with DEV: <a href=\"https://it.globalpark.de/twiki/bin/view/Development/DevEFSGuidelineCustomizing\"><u>https://it.globalpark.de/twiki/bin/view/Development/DevEFSGuidelineCustomizing</u></a></p></li>\n</ul><h2 id=\"header-3\">Description</h2><p>EFS verwendet ab Version 8.1 ein zentralisiertes EFS-Request-Routing (zentrales Einstiegsskript). Damit ist es nicht mehr möglich, die document_root des Web servers zu ändern und Anfragen auf die document_root z. B. an eine andere Domain oder auf eine bestimmte Umfrage auf derselben Installation umzuleiten.</p><p>Als Feature kann das auch nicht wieder sinnvoll eingebaut werden, weshalb es ab EFS 8.1 einen Plugin-Mechanismus für das Routing gibt.</p><p>Die Funktion kann genutzt werden, um jegliche Art von Spezial-Routing zu implementieren. Sie kann z. B. bestimmte Anfrage auf eine andere Domain umleiten und andere einfach durchlassen, sodass sie \"normal\" von EFS behandelt werden.</p><h3 id=\"header-5\">Preconditions</h3><ul>\n<li><p>EFS 8.1 or higher</p></li>\n<li>\n<p>EFS &lt; 10.0</p>\n<ul><li><p>in <code>htdocs/conf/config.inc.php3</code>: <code>$__has_routing_plugin = true</code></p></li></ul>\n</li>\n<li>\n<p>EFS &gt;= 10.0</p>\n<ul><li><p>in Platform-Cockpit: <code>has_routing_plugin = true</code></p></li></ul>\n</li>\n<li><p>File <code>htdocs/custom/routing/plugin.inc.php</code> exists, implements <code>function custom_routing_plugin()</code>.</p></li>\n<li><p>File has no <em>Parse error</em> while using the actual Version of PHP.</p></li>\n</ul><h3 id=\"header-6\">Implementation</h3><p>To start create the file <code>htdocs/custom/routing/plugin.inc.php</code>. This file must implement <code>function custom_routing_plugin()</code>. This function will be called by EFS for <strong>all Requests</strong> - if it is activated.</p><p>In EFS &lt; 10.0 in <code>htdocs/conf/config.inc.php3</code> the Variable <code>$__has_routing_plugin</code> has to be set to <em>true</em> to activate the Plugin. If <code>$__has_routing_plugin = false</code>, the Routing-Plugin will be ignored.</p><h3 id=\"header-7\">Notes</h3><ul>\n<li><p>A <em>Parse error</em> in this file forces a HTTP 500-Error (<em>internal server error</em>) for <strong>all</strong> Requests!</p></li>\n<li><p>Keep this function performant - being called in every Request it could be a Bottleneck.</p></li>\n<li><p>Having no <code>.htaccess</code> files this Module maybe an option for you.</p></li>\n</ul><h3 id=\"header-8\">Example</h3><pre><code class=\"language-text\">&lt;?php\n/*\ns. Doku: https://it.globalpark.de/twiki/bin/view/Development/DevEFSGuidelineCustomizing#Custom_Request_handling_Routing\n*/\n\nfunction custom_routing_plugin($originalUri)\n{\n        // handle all requests for https://www.peng.com/hihi* originaluri everytime include the protocol(e.g.https and a closing Slash)\n        if (preg_match('/^http[s]{0,1}:\\/\\/www.sozialerhebung.at(:443){0,1}\\/$/',$originalUri)) {\n                header('Location: http://www.aha.com');\n                die();\n        }\n        \n        // this should not be activated in production unless intended\n        if ($_SERVER['REQUEST_METHOD']=='POST') { \n                print \"POST REQUESTS ARE NOT ALLOWED\";\n                die();\n        }\n        \n        \n        // fallthrough, meaning EFS will take care of the rest and proceed with its normal request handling\n}</code></pre><p>Forward everything matching <a href=\"https://unipark.de/uc/KW/BIandAI/\">uc/KW/BIandAI/</a> from one installation to another installation.</p><pre><code class=\"language-text\">if (preg_match('/\\/uc\\/KW\\/BIandAI/',$originalUri))\n {\n                header('Location: https://ua4250.customervoice360.com/uc/KW/BIandAI/');\n                die();\n        }</code></pre><p>To test the routing before going live, you should put an if condition around the code so that the routing only applies for our internal IP address: Since the move to Frankfurt HTTP_X_FORWARDED_FOR has to be used instead of REMOTE_ADDR:</p><pre><code class=\"language-text\">if ($_SERVER['HTTP_X_FORWARDED_FOR']=='87.79.30.2'){     //or 87.79.30.37 when connected via office vpn, OLD: REMOTE_ADDR, NEW: HTTP_X_FORWARDED_FOR\n        // actual routing code\n        if (preg_match('/^http:\\/\\/(www\\.)?justisvarsel.no\\/$/',$originalUri)) {\n                header('Location: https://dh8342.customervoice360.com/uc/admin/b6cb/');\n                die();\n        }\n}</code></pre><p></p><p>Another Example, which has been used to implement a beyond 200 character limit IP white listing for a survey at <a href=\"http://cs-culture360.com\">cs-culture360.com</a>:</p><p></p><pre><code class=\"language-text\">&lt;?php\n/*\ns. Doku: https://it.globalpark.de/twiki/bin/view/Development/DevEFSGuidelineCustomizing#Custom_Request_handling_Routing\n*/\n\nfunction custom_routing_plugin($originalUri)\n{\n        // if( $_SERVER['HTTP_X_FORWARDED_FOR'] == '87.79.30.2' ) {    //or 87.79.30.37 when connected via office vpn\n        \n        if (preg_match('/\\/uc\\/admin\\/746a/',$originalUri)) {\n                \n                $tobechecked = $_SERVER['HTTP_X_FORWARDED_FOR'];\n                $single_IPs = array(\n                \"198.240.130.75\",\n                \"198.240.146.75\",\n                \"198.240.131.75\",\n                \"198.240.141.75\",\n                \"198.240.133.75\",\n                \"198.147.160.75\",\n                \"198.240.128.75\",\n                \"87.79.30.2\",     // Office-IP-Colonia\n                \"195.171.100.4\"   // Office-IP-Londinium\n                );\n                \n                if ( !(CheckIpRange($tobechecked,\"198.240.212.1\",\"198.240.212.254\")\n                || CheckIpRange($tobechecked,\"198.240.213.1\",\"198.240.213.254\")\n                || CheckIpRange($tobechecked,\"164.143.0.1\",\"164.143.255.254\")\n                || CheckIpRange($tobechecked,\"87.101.226.105\",\"87.101.226.110\")\n                || in_array($tobechecked,$single_IPs)))\n                \n                {\n                        header('Location: https://xy1234.customervoice360.com/uc/ipcheck/originalprojectname\n                        //     optional project to display a message instead of a blank page and mimics the exact behaviour of the default functionality\n                        // 1) create an AN copy of the original survey and turn off the use of cookies and privacy assistant\n                        // 2) remove all pages except one page with a 998 question where you add the orginal message text that should be shown if the IP check fails\n                        // 3) rename the \"Continue\" button to \"Login\"\n                        // 4) add the URL of the orginal survey to the \"Destination URL\" option in the properties of the final page, also deselect \"ospe\" and \"return_tic\" options\n                        // 5) change the URL to \"ipcheck/originalprojectname and activate the project with same end of survey (date/time) like original project\n                        die();');\n                        \n                        die();\n                }\n                \n        }\n        \n        // }\n        \n        // fallthrough, meaning EFS will take care of the rest and proceed with its normal request handling\n}\n\nfunction CheckIpRange($ip, $min, $max) {\n        return (ip2long($min) &lt;= ip2long($ip) &amp;&amp; ip2long($ip) &lt;= ip2long($max));\n}</code></pre><p></p><p>and another example used to route one of the domains on one installation to the customervoice domain of another installation. The source installation is in Rackspace. Therefore you have to try to match a (:8443) instead of port 443. The 8443 is used at Rackspace.</p><p></p><pre><code class=\"language-text\">&lt;?php\n/*\ns. Doku: https://it.globalpark.de/twiki/bin/view/Development/DevEFSGuidelineCustomizing#Custom_Request_handling_Routing\n*/\n\nfunction custom_routing_plugin($originalUri)\n{\n        \n        // handle all requests for https://www.peng.com/hihi* originaluri everytime include the protocol(e.g.https and a closing Slash)\n        if (preg_match('/mybluememberadvisorypanel.com(:8443){0,1}(.*)/',$originalUri,$matches)) {\n                header('Location: https://mq3022.customervoice360.com'.$matches[2]);\n                die();\n        }\n        \n        \n        \n        // fallthrough, meaning EFS will take care of the rest and proceed with its normal request handling\n}</code></pre><p>Example: Make installation unavailable for everyone except Nagios monitoring (soft deletion process)</p><p></p><pre><code class=\"language-text\">&lt;?php\n/*\ns. Doku: https://it.globalpark.de/twiki/bin/view/Development/DevEFSGuidelineCustomizing#Custom_Request_handling_Routing\n*/\n\nfunction custom_routing_plugin($originalUri)\n{\n        if( $_SERVER['HTTP_X_FORWARDED_FOR'] != '10.250.10.97' &amp;&amp; $_SERVER['HTTP_X_FORWARDED_FOR'] != '10.250.1.33' &amp;&amp; $_SERVER['HTTP_X_FORWARDED_FOR'] != '10.250.0.7' &amp;&amp; $_SERVER['HTTP_X_FORWARDED_FOR'] != '87.79.30.2') {\n                die();\n        }\n        // Nagios monitoring and office CGN are allowed, everyone else will get a blank page\n}</code></pre><p></p><h3 id=\"header-9\">Firewall based on Custom Routing Plugin</h3><p>Please see Firewall code hinzufügen <ac:link ac:card-appearance=\"inline\"><ri:page ri:content-title=\"TS-Firewall based on Custom Routing Plugin\" ri:version-at-save=\"4\"></ri:page><ac:link-body>TS-Firewall based on Custom Routing Plugin</ac:link-body></ac:link> </p><pre><code class=\"language-text\">&lt;?php\n/*\ns. Doku: https://it.globalpark.de/twiki/bin/view/Development/DevEFSGuidelineCustomizing#Custom_Request_handling_Routing\n*/\n\nfunction custom_routing_plugin($originalUri)\n{\n        @include_once gp_conf::get('basepath_extensions').'/TsCodeHelper/Firewall/Firewall.php';\n        TsCodeHelper\\Firewall\\Firewall::getInstance()\n        -&gt;run();\n}</code></pre><p></p><p><strong>Example for using a custom domain to open one specific survey:</strong></p><pre><code class=\"language-text\">&lt;?php\n/*\ns. Doku: https://it.globalpark.de/twiki/bin/view/Development/DevEFSGuidelineCustomizing#Custom_Request_handling_Routing\n*/\n\nfunction custom_routing_plugin($originalUri)\n{\n    if (preg_match('/^http[s]{0,1}:\\/\\/(www.)?pwcspaperspectives.com(:443){0,1}\\/$/',$originalUri))\n    {\n       header('Location: https://www.pwcspaperspectives.com/uc/ISPAIndustryRegistrationSite/');\n       die();\n    }\n\n    if (preg_match('/^http[s]{0,1}:\\/\\/www.coachingsurvey2015.com(:443){0,1}\\/$/',$originalUri))\n    {\n       header('Location: https://pwcresearch.com/uc/ICFReg/');\n       die();\n    }\n}</code></pre><p></p><p><strong>Example for routing participants using an obsolete path to a survey, with which they have been invited before the path has been changed.</strong></p><pre><code class=\"language-text\">&lt;?php\n/*\ns. Doku: https://it.globalpark.de/twiki/bin/view/Development/DevEFSGuidelineCustomizing#Custom_Request_handling_Routing\n*/\n\nfunction custom_routing_plugin($originalUri)\n{\n        if (preg_match('/\\/uc\\/main\\/9f89\\/\\?code=/',$originalUri)) {\n                $url = preg_replace('/main\\/9f89/','Hirslanden_Umfrage_Press_Ganey_stationaer',$originalUri);\n                header('Location: '.$url);\n                die();\n        }\n        if (preg_match('/\\/uc\\/Project_Manager2\\/8d87\\/\\?code=/',$originalUri)) {\n                $url = preg_replace('/Project_Manager2\\/8d87/','Hirslanden_Umfrage_Tagesklinik',$originalUri);\n                header('Location: '.$url);\n                die();\n        }\n\n        if (preg_match('/\\/uc\\/Project_Manager2\\/1453\\/\\?code=/',$originalUri)) {\n                $url = preg_replace('/Project_Manager2\\/1453/','Hirslanden_Umfrage_Notfallstation',$originalUri);\n                header('Location: '.$url);\n                die();\n        }\n}</code></pre><p></p><p><strong>an example for redirecting using a fixed number of parameters</strong></p><pre><code class=\"language-text\">&lt;?php\n/*\ns. Doku: https://it.globalpark.de/twiki/bin/view/Development/DevEFSGuidelineCustomizing#Custom_Request_handling_Routing\n*/      \n\nfunction custom_routing_plugin($originalUri)\n{      \n        if (preg_match('/http(s)?:\\/\\/www.efs-survey.com(:443)?\\/uc\\/bonprix\\_pers\\_2017\\/(\\?a=(.+)?\\&amp;b=(.+)?\\&amp;c=(.+)?)?/',$originalUri, $matches)) {\n            header('Location: https://nn1980.customervoice360.com/uc/bonprix_pers_2017/?a='.$matches[4].'&amp;b='.$matches[5].'&amp;c='.$matches[6]);\n            die();\n        }\n}</code></pre><p></p><p>another example for logging requests. In this case it was used to investigate SOAP requests.</p><pre><code class=\"language-text\">function custom_routing_plugin($originalUri)\n{\n    // handle all requests for https://www.peng.com/hihi* originaluri everytime include the protocol(e.g.https and a closing Slash)\n\n    //JIRA: https://jira.3uu.de/browse/KANBAN-11837 do not change this if statement only the kanban is solved or there are some other issues\n    // has apparently been taken out. The KANBAN has been closed in the meantime\n\n    // this is for debugging purpose due to case 00889096\n    //if ($_SERVER['HTTP_X_FORWARDED_FOR']=='87.79.30.2'){     //or 87.79.30.37 when connected via office vpn, OLD: REMOTE_ADDR, NEW: HTTP_X_FORWARDED_FOR\n        // actual routing code\n        if (preg_match('/handler=soap/',$originalUri)) {\n                //log complete request into file\n                $logfile = '/nfs/opst/xm2207.customervoice360.com/htdocs/conf/soaplog.txt';\n                $data = file_get_contents( 'php://input' );\n                $spl = NEW SplFileObject($logfile, \"a\");\n                $spl-&gt;fwrite ( date(\"Y-m-d H:i:s\") . ':: IP :' . print_r($_SERVER['HTTP_X_FORWARDED_FOR'],true) . \"\\n\");\n                $spl-&gt;fwrite ( date(\"Y-m-d H:i:s\") . ':: REQUEST :' . print_r($_REQUEST,true) . \"\\n\");\n                $spl-&gt;fwrite ( date(\"Y-m-d H:i:s\") . ':: GET  :' . print_r($_GET,true) . \"\\n\");\n                $spl-&gt;fwrite ( date(\"Y-m-d H:i:s\") . ':: POST  :' . print_r($_POST,true) . \"\\n\");\n                $spl-&gt;fwrite ( date(\"Y-m-d H:i:s\") . ':: FILE  :' . print_r($_FILE,true) . \"\\n\");\n                $spl-&gt;fwrite ( date(\"Y-m-d H:i:s\") . ':: DATA  :' . print_r($data,true) . \"\\n\");\n                //die(); //the request shall be processed. We only want to have a look.\n        }\n    //}\n\n\n}\n</code></pre><h3 id=\"header-10\">set add}itional headers like HSTS:</h3><p>header(\"Strict-Transport-Security:max-age=63072000\"); header(\"X-XSS-Protection: 1\"); header('X-Content-Type-Options: nosniff');</p><p></p><h3 id=\"header-11\">Projects</h3><p>Das Custom-Routing-Plugin wird genutzt z. B. bei:</p><ul>\n<li><p>unipark</p></li>\n<li><p>SBK</p></li>\n</ul><p></p><p>Pingdom IPs to exclude:</p>",
    "user_segment_ids": [
        360000084973
    ]
}