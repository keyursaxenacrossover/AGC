{
    "id": 20714786488082,
    "url": "https://discoverxi-supportdesk.zendesk.com/api/v2/help_center/en-us/articles/20714786488082.json",
    "html_url": "https://discoverxi-supportdesk.zendesk.com/hc/en-us/articles/20714786488082-Configuring-a-TS-Firewall-based-on-Custom-Routing-Plugin-WIP",
    "author_id": 369584192734,
    "comments_disabled": false,
    "draft": false,
    "promoted": false,
    "position": 0,
    "vote_sum": 0,
    "vote_count": 0,
    "section_id": 20714530860562,
    "created_at": "2024-08-12T17:00:44Z",
    "updated_at": "2024-09-10T14:05:02Z",
    "name": "Configuring a TS-Firewall based on Custom Routing Plugin (WIP)",
    "title": "Configuring a TS-Firewall based on Custom Routing Plugin (WIP)",
    "source_locale": "en-us",
    "locale": "en-us",
    "outdated": false,
    "outdated_locales": [],
    "edited_at": "2024-09-10T14:05:02Z",
    "user_segment_id": 360000084973,
    "permission_group_id": 1075294,
    "content_tag_ids": [],
    "label_names": [],
    "body": "<h1 id=\"h_01J7E40H1YP66KBGW735RP56S8\">Overview</h1>\n<p>The firewall based on the <a href=\"https://it.globalpark.de/twiki/bin/view/Support/Customizing-Modules:CustomRouting\"><u>Custom Routing Plugin</u></a> is used in case someone attacks an installation or panel website.<br>The attacker shall be fend off so that the panel and sensitive data can not be accessed and/or stolen.<br>Also we want to avoid too many accesses to the installation and thus too many queries or traffic that slows down the performance of the installation.</p>\n<p>The code for the firewall now is available on bitbucket:<br><a href=\"https://bitbucket.org/efs-ts/tscodehelper/src/master/\">https://bitbucket.org/efs-ts/tscodehelper/src/master/</a></p>\n<h2 id=\"h_01J7E3TZAB7DDDXVH0A6SWVG3K\">Table of Contents</h2>\n<ul>\n<li>\n<a href=\"#header-3\">How to activate it</a>\n<ul>\n<li><a href=\"#header-5\">Possible options for requestMatch</a></li>\n</ul>\n</li>\n<li><a href=\"#header-7\">Installations that have the firewall installed (17.08.2023):</a></li>\n</ul>\n<h2 id=\"header-3\">How to activate it</h2>\n<ul>\n<li>\n<p>On the console check out the files from git:</p>\n<pre><code class=\"language-text\"> cd /nfs/opstX/installation/projekte/ &amp;&amp; git clone git@bitbucket.org:efs-ts/TsCodehelper.git</code></pre>\n</li>\n<li>\n<p>Configure the firewall</p>\n<pre><code class=\"language-text\">    projekte/TsCodeHelper/Firewall/Conf/firewallconf.php\n\n    Example \n\n    $_fireWalls = array(\n\n        // Firewall 1\n        array(\n            'condition'               =&gt; array(\n                'class'                   =&gt; 'TsCodeHelper\\Firewall\\Condition\\Ip',          // Only ip for now, will be extended for different purposes (e.g. Panelist Email address whitelist)\n            ),\n            'options' =&gt; array(\n                'requestMatch'            =&gt; $_SERVER['REQUEST_METHOD'] == \"POST\" ,         // On the Fly boolean value if current request needs to be checked\n                'ipAddr'                  =&gt; $_SERVER[\"HTTP_X_FORWARDED_FOR\"],                       // Get IP Address from Request \n                'numberOfRequestsAllowed' =&gt; 10,                                            // Threshhold for adding to blacklist\n                'blackListFile'           =&gt; '/Conf/blacklist_'.date(\"Y_m_d_H\").'.lst',     // Blacklist of whatever criteria should be checked\n                'firewallLogFile'         =&gt; '/Logs/firewall.log',                          // Log blocked accesses? (auto logs if file is defined and writable)\n                'accessLogReplacement'    =&gt; '/Logs/custom_access_'.date(\"Y_m_d_H\").'.log', // Requests need to be logged additionally for firewal to work\n                'manualWhiteList'         =&gt; array(\n                    '87.79.30.2',\n                    '87.79.30.37',\n                ),\n                'manualBlackList'         =&gt; array()\n            ),\n            'requestHandler' =&gt; array(\n                'class'                   =&gt; 'TsCodeHelper\\Firewall\\Request\\Murder',        // Class to handle identified requests (If closure defined in routing plugin, class will be overwritten)\n            )\n        )\n    );</code></pre>\n</li>\n<li>\n<p>Add routing plugin file (if not yet existent):</p>\n<ul>\n<li>\n<p>within htdocs folder of installation</p>\n<ul>\n<li>\n<p>create folder if not yet existent: mkdir -p custom/routing</p>\n</li>\n<li>\n<p>cd custom/routing</p>\n</li>\n<li>\n<p>vi plugin.inc.php</p>\n</li>\n<li>\n<p>paste content from <a href=\"https://it.globalpark.de/twiki/bin/view/Support/Customizing-Modules:CustomRouting#Example\"><u>CustomRouting</u></a></p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>Initialize Firewall in routing plugin:</p>\n<pre><code class=\"language-text\">        @include_once gp_conf::get('basepath_extensions').'/TsCodeHelper/Firewall/Firewall.php';\n        TsCodeHelper\\Firewall\\Firewall::getInstance()\n                                      -&gt;run();</code></pre>\n</li>\n<li>\n<p>Enable routing plugin in EFS config using the root account</p>\n<ul>\n<li>\n<p>has_routing_plugin = true</p>\n</li>\n</ul>\n</li>\n<li>\n<p>Don't forget to add an update to the installation in Globis mentioning the config flags changed and the support case</p>\n</li>\n</ul>\n<p><br>At various points closures can be injected to react to individual situations.<br>E.g. in case of Respondi we do not simply use php function <strong>die()</strong> to show a blank page but show a custom message. This can be done as follows:</p>\n<pre><code class=\"language-text\">        // FW: Override what happens when Request was detected as malicious (default just ... get’s murdered)\n        $firewallRequestClosure = function(){\n            die(\"add custom message here\");\n        };\n\n        @include_once gp_conf::get('basepath_extensions').'/TsCodeHelper/Firewall/Firewall.php';\n        TsCodeHelper\\Firewall\\Firewall::getInstance()\n                                      -&gt;setRequestClosure($firewallRequestClosure)\n                                      -&gt;run();</code></pre>\n<p> </p>\n<h3 id=\"header-5\">Possible options for requestMatch</h3>\n<ul>\n<li>\n<p>Check for domain</p>\n<ul>\n<li>\n<pre><code class=\"language-text\">preg_match('/millsadvisorypanel.com/i', $_SERVER['SERVER_NAME'])</code></pre>\n</li>\n<li>\n<p>/i means case insensitive</p>\n</li>\n</ul>\n</li>\n<li>\n<p>Check for request method</p>\n<ul>\n<li>\n<pre><code class=\"language-text\">$_SERVER['REQUEST_METHOD'] == \"POST\"</code></pre>\n</li>\n<li>\n<pre><code class=\"language-text\">$_SERVER['REQUEST_METHOD'] == \"GET\"</code></pre>\n</li>\n</ul>\n</li>\n<li>\n<p>Check for specific session</p>\n<ul>\n<li>\n<pre><code class=\"language-text\">preg_match('/index\\.php\\?SES\\=a48e110c0e5199c6c41c231be1d79552/', $_SERVER[\"REQUEST_URI\"])</code></pre>\n</li>\n</ul>\n</li>\n<li>\n<p>Combined Checks</p>\n<ul>\n<li>\n<pre><code class=\"language-text\">$_SERVER['REQUEST_METHOD'] == \"POST\" &amp;&amp; preg_match('/index\\.php/',$_SERVER['REQUEST_URI']),</code></pre>\n</li>\n</ul>\n</li>\n</ul>\n<p> </p>\n<h2 id=\"header-7\">Installations that have the firewall installed (17.08.2023):</h2>\n<p> </p>\n<p><strong>Prod-DE</strong></p>\n<table style=\"width: 684px;\" data-layout=\"default\" data-table-width=\"760\">\n<tbody>\n<tr>\n<th style=\"width: 143.828px;\">\n<p><strong>technical name</strong></p>\n</th>\n<th style=\"width: 133.766px;\">\n<p><strong>customer</strong></p>\n</th>\n<th style=\"width: 180.5px;\">\n<p><strong>routing plugin active</strong></p>\n</th>\n<th style=\"width: 212.906px;\">\n<p><strong>comment</strong></p>\n</th>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>as1525</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Telekom</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p>will be purged 2024-02-19</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>bf7332</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Kantar</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p> </p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>eq5267</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Kantar</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p> </p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>fd9643</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Ipsos ICP</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p> </p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>ga6506</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Ipsos ICP</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p> </p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>gz4727</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Kantar</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p> </p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>kb1740</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Kantar</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p> </p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>mv7491</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Respondi</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p>archive installation<br>will be purged 2024-02-19</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>np3104</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Payback</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p> </p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>nr1388</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Skopos</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p> </p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>ur2469</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Gruner+Jahr</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p> </p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>wt2072</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>TRP Research</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>nope</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p> </p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>wv8816</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>FireflyInsight</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p> </p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>xb3732</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Respondi</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p>archive installation<br>will be purged 2024-02-19</p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>xn7072</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Kantar</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p> </p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>yt8972</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Omniquest</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p> </p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 135.828px;\">\n<p>zt6951</p>\n</td>\n<td style=\"width: 125.766px;\">\n<p>Kantar</p>\n</td>\n<td style=\"width: 172.5px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 204.906px;\">\n<p> </p>\n</td>\n</tr>\n</tbody>\n</table>\n<p> </p>\n<p><strong>Prod-US</strong></p>\n<table style=\"height: 110px; width: 685px;\" data-layout=\"default\" data-table-width=\"760\">\n<tbody>\n<tr style=\"height: 22px;\">\n<th style=\"width: 147.344px; height: 22px;\">\n<p><strong>technical name</strong></p>\n</th>\n<th style=\"width: 123.344px; height: 22px;\">\n<p><strong>customer</strong></p>\n</th>\n<th style=\"width: 169.312px; height: 22px;\">\n<p><strong>routing plugin active</strong></p>\n</th>\n<th style=\"width: 232px; height: 22px;\">\n<p><strong>comment</strong></p>\n</th>\n</tr>\n<tr style=\"height: 22px;\">\n<td style=\"width: 139.344px; height: 22px;\">\n<p>nh0062</p>\n</td>\n<td style=\"width: 115.344px; height: 22px;\">\n<p>TsR</p>\n</td>\n<td style=\"width: 161.312px; height: 22px;\">\n<p>nope</p>\n</td>\n<td style=\"width: 224px; height: 22px;\">\n<p> </p>\n</td>\n</tr>\n<tr style=\"height: 22px;\">\n<td style=\"width: 139.344px; height: 22px;\">\n<p>rb3482</p>\n</td>\n<td style=\"width: 115.344px; height: 22px;\">\n<p>TsR</p>\n</td>\n<td style=\"width: 161.312px; height: 22px;\">\n<p>nope</p>\n</td>\n<td style=\"width: 224px; height: 22px;\">\n<p> </p>\n</td>\n</tr>\n<tr style=\"height: 22px;\">\n<td style=\"width: 139.344px; height: 22px;\">\n<p>ta3215</p>\n</td>\n<td style=\"width: 115.344px; height: 22px;\">\n<p>TsR</p>\n</td>\n<td style=\"width: 161.312px; height: 22px;\">\n<p>nope</p>\n</td>\n<td style=\"width: 224px; height: 22px;\">\n<p>will be purged on 2024-01-15</p>\n</td>\n</tr>\n<tr style=\"height: 22px;\">\n<td style=\"width: 139.344px; height: 22px;\">\n<p>xt2131</p>\n</td>\n<td style=\"width: 115.344px; height: 22px;\">\n<p>TsR</p>\n</td>\n<td style=\"width: 161.312px; height: 22px;\">\n<p>nope</p>\n</td>\n<td style=\"width: 224px; height: 22px;\">\n<p> </p>\n</td>\n</tr>\n</tbody>\n</table>\n<p> </p>\n<p><strong>BofA-US</strong></p>\n<table style=\"width: 683px;\" data-layout=\"default\" data-table-width=\"760\">\n<tbody>\n<tr>\n<th style=\"width: 149.516px;\">\n<p><strong>technical  name</strong></p>\n</th>\n<th style=\"width: 127.953px;\">\n<p><strong>customer</strong></p>\n</th>\n<th style=\"width: 185.469px;\">\n<p><strong>routing plugin active</strong></p>\n</th>\n<th style=\"width: 207.062px;\">\n<p><strong>comment</strong></p>\n</th>\n</tr>\n<tr>\n<td style=\"width: 141.516px;\">\n<p>gb8879</p>\n</td>\n<td style=\"width: 119.953px;\">\n<p>Ipsos</p>\n</td>\n<td style=\"width: 177.469px;\">\n<p>yes</p>\n</td>\n<td style=\"width: 199.062px;\">\n<p> </p>\n</td>\n</tr>\n<tr>\n<td style=\"width: 141.516px;\">\n<p> </p>\n</td>\n<td style=\"width: 119.953px;\">\n<p> </p>\n</td>\n<td style=\"width: 177.469px;\">\n<p> </p>\n</td>\n<td style=\"width: 199.062px;\">\n<p> </p>\n</td>\n</tr>\n</tbody>\n</table>\n<p> </p>\n<p><strong>even more Tips and Tricks:</strong></p>\n<p>If you need to extract IPs from the blacklist files to put them on the permanent blacklist, you can do this like this:</p>\n<pre><code class=\"language-text\">thurn_mathias@servicegw-prod-de-03:/nfs/installations/wv8816/nfs/opst/wv8816.customervoice360.com/projekte/TsCodeHelper/Firewall/Conf$ for i in $(sort blacklist_2020_05_11_03.lst | uniq | head -n 10); do php -r \"echo \\\"'\\\" . long2ip($i) . \\\"',\\\" . \\\"\\n\\\";\"; done\n'77.83.85.11',\n'77.83.85.15',\n'77.83.85.20',\n'77.83.85.43',\n'77.83.85.48',\n'77.83.85.58',\n'77.83.85.99',\n'77.83.85.147',\n'77.83.85.160',</code></pre>",
    "user_segment_ids": [
        360000084973
    ]
}